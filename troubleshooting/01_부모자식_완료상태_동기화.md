# 부모-자식 완료 상태 동기화

## 문제 상황
하위 항목이 모두 완료되면 부모도 자동으로 완료되어야 하는데, 계산된 값이 실제 데이터에 반영되지 않아 상태가 불일치했습니다.

```
☐ 리액트 공부하기 (부모) ← 자식이 모두 완료인데 미완료 상태!
  ☑ useState 이해하기 (자식1) ✅
  ☑ 컴포넌트 학습 (자식2) ✅
```

## 시도한 방법
```typescript
// ❌ 계산만 하고 저장하지 않음
const completedCount = todo.children.filter(child => child.completed).length;
const totalCount = todo.children.length;
const parentCompleted = completedCount === totalCount;  // 계산된 값은 사라짐
```

**문제점:**
- 계산된 값이 실제 데이터에 저장되지 않음
- 다른 작업을 하면 리셋됨
- 손자가 완료되어도 부모까지 전파되지 않음

## 해결 방법: 2단계 업데이트 전략

### 1. 하위로 전파 (부모 → 자식들)
부모를 체크하면 모든 하위 항목도 함께 완료/미완료

```typescript
function setAllChildrenCompleted(todo: Todo, completed: boolean): Todo {
    return {
        ...todo,
        completed: completed,  // 실제 데이터에 저장
        children: todo.children.map(child => 
            setAllChildrenCompleted(child, completed)  // 재귀로 모든 하위 항목 처리
        )
    };
}
```

### 2. 상위로 전파 (자식들 → 부모)
모든 자식이 완료되면 부모도 자동으로 완료

```typescript
export function updateParentCompleted(todo: Todo): Todo {
    // 1. 먼저 모든 자식 업데이트 (손자 → 자식 → 부모 순서)
    const updatedChildren = todo.children.map(child => 
        updateParentCompleted(child)
    );
    
    // 2. 자식이 없으면 현재 상태 유지
    if (updatedChildren.length === 0) {
        return { ...todo, children: updatedChildren };
    }
    
    // 3. 모든 자식이 완료되었는지 확인
    const allCompleted = updatedChildren.every(child => child.completed);
    
    // 4. 부모의 completed를 실제로 변경
    return {
        ...todo,
        completed: allCompleted,
        children: updatedChildren
    };
}
```

### 토글 함수에 적용
```typescript
export function getToggleTodo(todoArray: Todo[], targetId: string): Todo[] {
    // 1단계: 클릭한 항목 토글 + 하위로 전파
    const toggledArray = todoArray.map(todo => {
        if (todo.id === targetId) {
            return setAllChildrenCompleted(todo, !todo.completed);
        }
        if (todo.children.length > 0) {
            return { ...todo, children: getToggleTodo(todo.children, targetId) };
        }
        return todo;
    });
    
    // 2단계: 전체 트리 순회하며 상위로 전파
    return toggledArray.map(todo => updateParentCompleted(todo));
}
```

## 추가 문제: 자식 추가/삭제 시 동기화

### 문제
자식을 추가하거나 삭제할 때 부모 상태가 자동으로 업데이트되지 않음

```typescript
// ❌ 부모 상태 업데이트 안됨
function addChildTodo(parentId: string, childText: string) {
    setTodos(getAddChildTodo(todos, parentId, childText));
}
```

### 잘못된 시도
```typescript
// ❌ setTodos를 두 번 호출 (비동기 문제)
function addChildTodo(parentId: string, childText: string) {
    setTodos(getAddChildTodo(todos, parentId, childText));
    setTodos(todos.map(todo => updateParentCompleted(todo)));  // todos는 아직 업데이트 안됨!
}
```

### 해결 방법
중간 변수에 저장하여 순차 처리 후 한 번만 `setTodos` 호출

```typescript
// ✅ 올바른 방법
function addChildTodo(parentId: string, childText: string) {
    // 1단계: 자식 추가
    const updatedTodos = getAddChildTodo(todos, parentId, childText);
    
    // 2단계: 부모 상태 업데이트
    const finalTodos = updatedTodos.map(todo => updateParentCompleted(todo));
    
    // 3단계: 최종 결과만 저장
    setTodos(finalTodos);
}

function deleteTodo(id: string) {
    const updatedTodos = getDeleteTodo(todos, id);
    const finalTodos = updatedTodos.map(todo => updateParentCompleted(todo));
    setTodos(finalTodos);
}
```